<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>AutoPe√ßas</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', -apple-system, sans-serif; background: #0f172a; color: #f8fafc; min-height: 100vh; }
    
    .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    .loading-screen.hidden { display: none; }
    .loading-logo { font-size: 80px; margin-bottom: 20px; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid #334155; border-top: 3px solid #f59e0b; border-radius: 50%; animation: spin 1s linear infinite; margin-top: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .login-screen { min-height: 100vh; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-screen.hidden { display: none; }
    .login-box { background: #1e293b; border-radius: 20px; padding: 40px 30px; width: 100%; max-width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid #334155; position: relative; }
    .back-btn { position: absolute; top: 15px; left: 15px; background: transparent; border: none; color: #94a3b8; font-size: 16px; cursor: pointer; padding: 8px 12px; }
    .back-btn.hidden { display: none; }
    .logo-container { text-align: center; margin-bottom: 30px; }
    .logo-icon { font-size: 60px; display: block; margin-bottom: 10px; }
    .logo-text { font-size: 28px; font-weight: 700; }
    .logo-subtext { color: #64748b; font-size: 14px; margin-top: 5px; }
    .login-title { color: #94a3b8; font-size: 16px; text-align: center; margin-bottom: 20px; }
    .user-grid { display: flex; flex-direction: column; gap: 10px; }
    .user-btn { display: flex; align-items: center; gap: 15px; padding: 15px 20px; background: #0f172a; border: 2px solid #334155; border-radius: 12px; cursor: pointer; text-align: left; color: #f8fafc; }
    .user-btn:hover { border-color: #f59e0b; }
    .user-avatar { font-size: 28px; }
    .user-name { flex: 1; font-size: 16px; font-weight: 600; }
    .user-role { font-size: 12px; }
    .user-role.admin { color: #f59e0b; }
    .user-role.func { color: #64748b; }
    .senha-container { display: flex; flex-direction: column; gap: 15px; }
    .senha-container.hidden { display: none; }
    .senha-input { width: 100%; padding: 16px 20px; background: #0f172a; border: 2px solid #334155; border-radius: 12px; color: #f8fafc; font-size: 16px; outline: none; }
    .senha-input:focus { border-color: #f59e0b; }
    .erro-text { color: #ef4444; font-size: 14px; text-align: center; display: none; }
    .login-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #0f172a; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; }

    .app-screen { display: none; }
    .app-screen.active { display: block; }

    .header { background: #1e293b; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-logo { font-size: 32px; }
    .header-title { font-size: 18px; font-weight: 700; }
    .connection-status { font-size: 11px; }
    .connection-status.online { color: #22c55e; }
    .connection-status.offline { color: #ef4444; }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .catalogo-btn { background: #7c3aed; color: #fff; border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }
    .logout-btn { background: #334155; color: #f8fafc; border: none; padding: 8px 15px; border-radius: 8px; font-size: 13px; cursor: pointer; }

    .online-bar { display: flex; align-items: center; gap: 10px; padding: 10px 20px; background: #0f172a; border-bottom: 1px solid #334155; overflow-x: auto; }
    .online-bar.hidden { display: none; }
    .online-label { color: #64748b; font-size: 12px; }
    .online-user { background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 10px; border-radius: 20px; font-size: 11px; }

    .filter-bar { display: flex; gap: 8px; padding: 15px 20px; overflow-x: auto; background: #1e293b; border-bottom: 1px solid #334155; }
    .filter-btn { background: #0f172a; color: #94a3b8; border: 1px solid #334155; padding: 8px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; }
    .filter-btn.active { background: #f59e0b; color: #0f172a; border-color: #f59e0b; font-weight: 600; }

    .main { padding: 20px; padding-bottom: 100px; }
    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-icon { font-size: 60px; display: block; margin-bottom: 15px; opacity: 0.5; }
    .empty-text { font-size: 18px; margin-bottom: 5px; }
    .empty-subtext { color: #64748b; font-size: 14px; }

    .pecas-list { display: flex; flex-direction: column; gap: 12px; }
    .peca-card { background: #1e293b; border-radius: 12px; padding: 15px; display: flex; gap: 15px; align-items: center; cursor: pointer; border: 1px solid #334155; }
    .peca-icon-box { width: 50px; height: 50px; border-radius: 8px; background: #0f172a; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .peca-info { flex: 1; min-width: 0; }
    .peca-codigo { color: #f59e0b; font-size: 14px; font-weight: 700; font-family: monospace; }
    .peca-nome { font-size: 14px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .peca-meta { display: flex; gap: 15px; margin-top: 5px; color: #64748b; font-size: 11px; }
    .peca-status { padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; }
    .status-pendente { background: #451a03; color: #f59e0b; }
    .status-comprado { background: #052e16; color: #22c55e; }
    .status-nao_possivel { background: #450a0a; color: #ef4444; }
    .status-chegou { background: #172554; color: #3b82f6; }

    .add-btn { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #0f172a; border: none; padding: 16px 40px; border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 10px 40px rgba(245, 158, 11, 0.4); z-index: 100; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: flex-end; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-overlay.hidden { display: none; }
    .modal-overlay.center { align-items: center; }
    .modal { background: #1e293b; border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
    .modal.rounded { border-radius: 20px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #334155; }
    .modal-title { font-size: 18px; font-weight: 700; }
    .close-btn { background: #334155; color: #f8fafc; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 15px 20px; display: flex; gap: 10px; border-top: 1px solid #334155; }

    .input-group { margin-bottom: 20px; }
    .label { display: block; color: #94a3b8; font-size: 13px; margin-bottom: 8px; }
    .input { width: 100%; padding: 14px 16px; background: #0f172a; border: 2px solid #334155; border-radius: 10px; color: #f8fafc; font-size: 15px; outline: none; }
    .input:focus { border-color: #f59e0b; }
    .buscar-btn { width: 100%; padding: 14px; background: #059669; color: #fff; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 10px; }
    .buscar-btn:disabled { opacity: 0.6; }
    .resultado-busca { margin-top: 15px; padding: 15px; border-radius: 10px; font-size: 13px; }
    .resultado-busca.encontrado { background: #052e16; border: 1px solid #22c55e; color: #86efac; }
    .resultado-busca.nao-encontrado { background: #451a03; border: 1px solid #f59e0b; color: #fcd34d; }
    .resultado-busca.hidden { display: none; }
    .textarea { width: 100%; padding: 14px; background: #0f172a; border: 2px solid #334155; border-radius: 10px; color: #f8fafc; font-size: 15px; outline: none; resize: vertical; font-family: inherit; }

    .info-encontrada { background: #052e16; border: 1px solid #22c55e; border-radius: 12px; padding: 15px; margin-bottom: 20px; display: none; }
    .info-header { color: #22c55e; font-size: 14px; font-weight: 600; margin-bottom: 12px; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .info-label { color: #86efac; font-size: 13px; }
    .info-value { color: #f0fdf4; font-size: 14px; font-weight: 500; }
    .veiculos-lista { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .veiculo-tag { background: #166534; color: #bbf7d0; padding: 4px 10px; border-radius: 20px; font-size: 11px; }

    .cancel-btn { flex: 1; padding: 14px; background: #334155; color: #f8fafc; border: none; border-radius: 10px; font-size: 15px; cursor: pointer; }
    .submit-btn { flex: 2; padding: 14px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #0f172a; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer; }
    .submit-btn.purple { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: #fff; }

    .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #334155; }
    .detail-label { color: #64748b; font-size: 13px; }
    .detail-value { color: #f8fafc; font-size: 14px; font-weight: 500; text-align: right; max-width: 60%; }

    .admin-actions { margin-top: 25px; padding: 20px; background: #0f172a; border-radius: 12px; }
    .admin-title { color: #f59e0b; font-size: 14px; font-weight: 600; margin-bottom: 15px; }
    .status-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    .status-btn { padding: 10px 15px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; }
    .delete-btn { width: 100%; padding: 12px; background: #7f1d1d; color: #fca5a5; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
    .func-info { margin-top: 20px; padding: 15px; background: #1e3a5f; border-radius: 10px; color: #93c5fd; font-size: 13px; text-align: center; }

    .sub-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
    .sub-modal-overlay.hidden { display: none; }
    .sub-modal { background: #1e293b; border-radius: 16px; padding: 25px; width: 100%; max-width: 350px; }
    .sub-modal-title { font-size: 18px; margin-bottom: 15px; text-align: center; }
    .sub-modal-buttons { display: flex; gap: 10px; margin-top: 20px; }

    .catalogo-stats { background: #0f172a; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    .catalogo-stats-number { font-size: 32px; font-weight: 700; color: #f59e0b; }
    .catalogo-stats-label { color: #64748b; font-size: 13px; }

    .tipos-lista { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .tipo-option { padding: 8px 14px; background: #0f172a; border: 2px solid #334155; border-radius: 8px; font-size: 13px; cursor: pointer; color: #94a3b8; }
    .tipo-option.selected { border-color: #f59e0b; background: #451a03; color: #f59e0b; }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">üî©</div>
    <div class="loading-spinner"></div>
  </div>

  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <button class="back-btn hidden" id="backBtn" onclick="showUserSelect()">‚Üê Voltar</button>
      <div class="logo-container">
        <span class="logo-icon" id="loginIcon">üî©</span>
        <h1 class="logo-text" id="loginTitle">AutoPe√ßas</h1>
        <p class="logo-subtext" id="loginSubtext">Controle de Estoque</p>
      </div>
      <div id="userSelectDiv">
        <h2 class="login-title">Quem √© voc√™?</h2>
        <div class="user-grid" id="userGrid"><p style="color:#64748b;text-align:center">Carregando...</p></div>
      </div>
      <div id="passwordDiv" class="senha-container hidden">
        <h2 class="login-title">Digite sua senha</h2>
        <input type="password" class="senha-input" id="senhaInput" placeholder="Senha" onkeypress="if(event.key==='Enter')doLogin()">
        <p class="erro-text" id="erroText">Senha incorreta!</p>
        <button class="login-btn" id="loginBtn" onclick="doLogin()">Entrar</button>
      </div>
    </div>
  </div>

  <div class="app-screen" id="appScreen">
    <header class="header">
      <div class="header-left">
        <span class="header-logo">üî©</span>
        <div>
          <h1 class="header-title">AutoPe√ßas</h1>
          <span class="connection-status offline" id="connectionStatus">‚óè Conectando...</span>
        </div>
      </div>
      <div class="header-right">
        <button class="catalogo-btn" id="catalogoBtn" onclick="openCatalogoModal()" style="display:none">üìö Cat√°logo</button>
        <button class="logout-btn" onclick="doLogout()">Sair</button>
      </div>
    </header>

    <div class="online-bar hidden" id="onlineBar">
      <span class="online-label">üë• Online:</span>
      <div id="onlineUsers"></div>
    </div>

    <div class="filter-bar">
      <button class="filter-btn active" data-filter="todos" onclick="setFilter('todos')">üìã Todos</button>
      <button class="filter-btn" data-filter="pendente" onclick="setFilter('pendente')">üü° Pendentes</button>
      <button class="filter-btn" data-filter="comprado" onclick="setFilter('comprado')">üü¢ Pedidos</button>
      <button class="filter-btn" data-filter="nao_possivel" onclick="setFilter('nao_possivel')">üî¥ Indispon√≠vel</button>
      <button class="filter-btn" data-filter="chegou" onclick="setFilter('chegou')">‚úÖ Chegaram</button>
    </div>

    <main class="main">
      <div class="empty-state" id="emptyState">
        <span class="empty-icon">üì¶</span>
        <p class="empty-text">Nenhuma pe√ßa encontrada</p>
        <p class="empty-subtext">Clique em "Pedir Pe√ßa" para adicionar</p>
      </div>
      <div class="pecas-list" id="pecasList"></div>
    </main>

    <button class="add-btn" onclick="openAddModal()">+ Pedir Pe√ßa</button>
  </div>

  <!-- Modal Pedir Pe√ßa -->
  <div class="modal-overlay hidden" id="addModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üî© Pedir Pe√ßa</h2>
        <button class="close-btn" onclick="closeAddModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <label class="label">C√≥digo da Pe√ßa *</label>
          <input type="text" class="input" id="codigoInput" placeholder="Ex: PSL55" oninput="this.value=this.value.toUpperCase()">
          <button class="buscar-btn" id="buscarBtn" onclick="buscarPeca()">üîç Buscar no Cat√°logo</button>
          <div class="resultado-busca hidden" id="resultadoBusca"></div>
        </div>
        <div class="info-encontrada" id="infoEncontrada"></div>
        <div class="input-group">
          <label class="label">Nome / Descri√ß√£o</label>
          <input type="text" class="input" id="nomeInput" placeholder="Ex: Filtro de √≥leo">
        </div>
        <div class="input-group">
          <label class="label">Quantidade</label>
          <input type="text" class="input" id="quantidadeInput" placeholder="Ex: 2 unidades">
        </div>
        <div class="input-group">
          <label class="label">Observa√ß√£o</label>
          <textarea class="textarea" id="obsInput" rows="2" placeholder="Info extra..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" onclick="closeAddModal()">Cancelar</button>
        <button class="submit-btn" onclick="submitPeca()">‚úì Pedir Pe√ßa</button>
      </div>
    </div>
  </div>

  <!-- Modal Detalhes -->
  <div class="modal-overlay hidden" id="detailModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üìã Detalhes</h2>
        <button class="close-btn" onclick="closeDetailModal()">‚úï</button>
      </div>
      <div class="modal-body" id="detailBody"></div>
    </div>
  </div>

  <!-- Modal Cat√°logo (s√≥ admin) -->
  <div class="modal-overlay hidden center" id="catalogoModal">
    <div class="modal rounded">
      <div class="modal-header">
        <h2 class="modal-title">üìö Cadastrar Pe√ßa no Cat√°logo</h2>
        <button class="close-btn" onclick="closeCatalogoModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="catalogo-stats">
          <div class="catalogo-stats-number" id="catalogoTotal">0</div>
          <div class="catalogo-stats-label">pe√ßas no cat√°logo</div>
        </div>
        
        <div class="input-group">
          <label class="label">C√≥digo da Pe√ßa *</label>
          <input type="text" class="input" id="catCodigoInput" placeholder="Ex: PSL55" oninput="this.value=this.value.toUpperCase()">
        </div>
        
        <div class="input-group">
          <label class="label">Tipo *</label>
          <div class="tipos-lista" id="tiposLista">
            <div class="tipo-option" onclick="selectTipo(this, 'Filtro de √ìleo')">Filtro de √ìleo</div>
            <div class="tipo-option" onclick="selectTipo(this, 'Filtro de Ar')">Filtro de Ar</div>
            <div class="tipo-option" onclick="selectTipo(this, 'Filtro de Cabine')">Filtro de Cabine</div>
            <div class="tipo-option" onclick="selectTipo(this, 'Filtro de Combust√≠vel')">Filtro Combust√≠vel</div>
            <div class="tipo-option" onclick="selectTipo(this, 'Vela de Igni√ß√£o')">Vela de Igni√ß√£o</div>
            <div class="tipo-option" onclick="selectTipo(this, 'Cabo de Vela')">Cabo de Vela</div>
            <div class="tipo-option" onclick="selectTipo(this, 'Pastilha de Freio')">Pastilha de Freio</div>
            <div class="tipo-option" onclick="selectTipo(this, 'Correia Dentada')">Correia Dentada</div>
            <div class="tipo-option" onclick="selectTipo(this, 'Tensor de Correia')">Tensor</div>
            <div class="tipo-option" onclick="selectTipo(this, 'Amortecedor')">Amortecedor</div>
          </div>
          <input type="text" class="input" id="catTipoInput" placeholder="Ou digite um tipo personalizado" style="margin-top:10px">
        </div>
        
        <div class="input-group">
          <label class="label">Marca *</label>
          <input type="text" class="input" id="catMarcaInput" placeholder="Ex: Tecfil, NGK, Bosch...">
        </div>
        
        <div class="input-group">
          <label class="label">Ve√≠culos Compat√≠veis (separe por v√≠rgula)</label>
          <textarea class="textarea" id="catVeiculosInput" rows="2" placeholder="Ex: GM Corsa, GM Celta, VW Gol G5"></textarea>
        </div>
        
        <div class="resultado-busca hidden" id="catalogoResultado"></div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" onclick="closeCatalogoModal()">Cancelar</button>
        <button class="submit-btn purple" onclick="cadastrarPeca()">üìö Cadastrar no Cat√°logo</button>
      </div>
    </div>
  </div>

  <!-- Sub-modais -->
  <div class="sub-modal-overlay hidden" id="compradoModal">
    <div class="sub-modal">
      <h3 class="sub-modal-title">üü¢ Pedido Feito</h3>
      <p style="color:#94a3b8;font-size:14px;margin-bottom:10px">Data estimada (opcional):</p>
      <input type="text" class="input" id="dataEstimadaInput" placeholder="Ex: 15/01/2026">
      <div class="sub-modal-buttons">
        <button class="cancel-btn" onclick="closeCompradoModal()">Cancelar</button>
        <button class="submit-btn" onclick="confirmComprado()">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="sub-modal-overlay hidden" id="naoDisponivelModal">
    <div class="sub-modal">
      <h3 class="sub-modal-title">üî¥ N√£o Dispon√≠vel</h3>
      <p style="color:#94a3b8;font-size:14px;margin-bottom:10px">Motivo:</p>
      <select class="input" id="motivoSelect">
        <option value="">Selecione...</option>
        <option value="N√£o tem na distribuidora">N√£o tem na distribuidora</option>
        <option value="N√£o consegui comprar">N√£o consegui comprar</option>
        <option value="Pre√ßo muito alto">Pre√ßo muito alto</option>
        <option value="Outro">Outro</option>
      </select>
      <div class="sub-modal-buttons">
        <button class="cancel-btn" onclick="closeNaoDisponivelModal()">Cancelar</button>
        <button class="submit-btn" onclick="confirmNaoDisponivel()">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    const SERVER_URL = 'https://pecas-server.onrender.com';
    const WS_URL = 'wss://pecas-server.onrender.com';

    const STATUS_CONFIG = {
      pendente: { label: 'Pendente', icon: 'üü°' },
      comprado: { label: 'Pedido Feito', icon: 'üü¢' },
      nao_possivel: { label: 'N√£o Dispon√≠vel', icon: 'üî¥' },
      chegou: { label: 'Chegou', icon: '‚úÖ' }
    };

    let usuarios = [];
    let currentUser = null;
    let selectedUserId = null;
    let pecas = [];
    let currentFilter = 'todos';
    let ws = null;
    let currentDetailPeca = null;
    let currentInfoPeca = null;
    let selectedTipo = '';

    // ============================================
    // INICIALIZA√á√ÉO
    // ============================================
    window.onload = async function() {
      const savedUser = localStorage.getItem('autopecas_user');
      
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appScreen').classList.add('active');
        
        // Mostra bot√£o cat√°logo s√≥ pra admin
        if (currentUser.role === 'admin') {
          document.getElementById('catalogoBtn').style.display = 'block';
        }
        
        connectWebSocket();
        loadCatalogoStats();
      } else {
        try {
          const res = await fetch(`${SERVER_URL}/usuarios`);
          usuarios = await res.json();
          renderUsers();
        } catch(e) {
          document.getElementById('userGrid').innerHTML = '<p style="color:#ef4444">Erro ao conectar</p>';
        }
        setTimeout(() => document.getElementById('loadingScreen').classList.add('hidden'), 1000);
      }
    };

    async function loadCatalogoStats() {
      try {
        const res = await fetch(`${SERVER_URL}/catalogo`);
        const data = await res.json();
        document.getElementById('catalogoTotal').textContent = data.total;
      } catch(e) {}
    }

    function renderUsers() {
      document.getElementById('userGrid').innerHTML = usuarios.map(u => `
        <button class="user-btn" onclick="selectUser(${u.id})">
          <span class="user-avatar">${u.avatar}</span>
          <span class="user-name">${u.name}</span>
          <span class="user-role ${u.role === 'admin' ? 'admin' : 'func'}">${u.role === 'admin' ? 'Admin' : 'Funcion√°rio'}</span>
        </button>
      `).join('');
    }

    function selectUser(id) {
      selectedUserId = id;
      const user = usuarios.find(u => u.id === id);
      document.getElementById('userSelectDiv').classList.add('hidden');
      document.getElementById('passwordDiv').classList.remove('hidden');
      document.getElementById('backBtn').classList.remove('hidden');
      document.getElementById('loginIcon').textContent = user.avatar;
      document.getElementById('loginTitle').textContent = user.name;
      document.getElementById('loginSubtext').textContent = '';
      document.getElementById('senhaInput').focus();
    }

    function showUserSelect() {
      selectedUserId = null;
      document.getElementById('userSelectDiv').classList.remove('hidden');
      document.getElementById('passwordDiv').classList.add('hidden');
      document.getElementById('backBtn').classList.add('hidden');
      document.getElementById('loginIcon').textContent = 'üî©';
      document.getElementById('loginTitle').textContent = 'AutoPe√ßas';
      document.getElementById('loginSubtext').textContent = 'Controle de Estoque';
      document.getElementById('senhaInput').value = '';
      document.getElementById('erroText').style.display = 'none';
    }

    async function doLogin() {
      const senha = document.getElementById('senhaInput').value;
      const btn = document.getElementById('loginBtn');
      btn.disabled = true; btn.textContent = 'Entrando...';

      try {
        const res = await fetch(`${SERVER_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: selectedUserId, senha })
        });
        const data = await res.json();
        if (data.sucesso) {
          currentUser = data.user;
          localStorage.setItem('autopecas_user', JSON.stringify(currentUser));
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('appScreen').classList.add('active');
          
          if (currentUser.role === 'admin') {
            document.getElementById('catalogoBtn').style.display = 'block';
          }
          
          connectWebSocket();
          loadCatalogoStats();
        } else {
          document.getElementById('erroText').style.display = 'block';
          document.getElementById('senhaInput').value = '';
        }
      } catch(e) {
        document.getElementById('erroText').textContent = 'Erro de conex√£o';
        document.getElementById('erroText').style.display = 'block';
      }
      btn.disabled = false; btn.textContent = 'Entrar';
    }

    function doLogout() {
      if (ws) ws.close();
      localStorage.removeItem('autopecas_user');
      currentUser = null;
      pecas = [];
      document.getElementById('appScreen').classList.remove('active');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('catalogoBtn').style.display = 'none';
      
      fetch(`${SERVER_URL}/usuarios`)
        .then(res => res.json())
        .then(data => { usuarios = data; renderUsers(); })
        .catch(() => {});
      
      showUserSelect();
    }

    function connectWebSocket() {
      ws = new WebSocket(WS_URL);
      ws.onopen = () => {
        document.getElementById('connectionStatus').textContent = '‚óè Online';
        document.getElementById('connectionStatus').className = 'connection-status online';
        ws.send(JSON.stringify({ type: 'join', user: currentUser }));
      };
      ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type === 'sync' || data.type === 'update') {
          pecas = data.pecas || [];
          renderPecas();
          if (data.onlineUsers) renderOnlineUsers(data.onlineUsers);
        }
        if (data.type === 'userUpdate') renderOnlineUsers(data.onlineUsers || []);
        if (data.type === 'catalogoAtualizado') {
          document.getElementById('catalogoTotal').textContent = data.total;
        }
      };
      ws.onclose = () => {
        document.getElementById('connectionStatus').textContent = '‚óè Offline';
        document.getElementById('connectionStatus').className = 'connection-status offline';
        setTimeout(connectWebSocket, 3000);
      };
    }

    function sendMessage(type, payload = {}) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type, ...payload, user: currentUser }));
      }
    }

    function renderOnlineUsers(users) {
      const bar = document.getElementById('onlineBar');
      if (users.length > 0) {
        bar.classList.remove('hidden');
        document.getElementById('onlineUsers').innerHTML = users.map(u => `<span class="online-user">${u}</span>`).join('');
      } else bar.classList.add('hidden');
    }

    function renderPecas() {
      const list = document.getElementById('pecasList');
      const empty = document.getElementById('emptyState');
      let filtered = pecas.filter(p => currentFilter === 'todos' ? p.status !== 'chegou' : p.status === currentFilter);
      if (filtered.length === 0) {
        list.innerHTML = ''; empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        list.innerHTML = filtered.map(p => `
          <div class="peca-card" onclick="openDetailModal('${p.id}')">
            <div class="peca-icon-box">üîß</div>
            <div class="peca-info">
              <div class="peca-codigo">${p.codigo}</div>
              <div class="peca-nome">${p.nome || 'Sem nome'}</div>
              <div class="peca-meta"><span>Por: ${p.pedidoPor}</span><span>${new Date(p.data).toLocaleDateString('pt-BR')}</span></div>
            </div>
            <div class="peca-status status-${p.status}">${STATUS_CONFIG[p.status]?.icon || ''} ${STATUS_CONFIG[p.status]?.label || p.status}</div>
          </div>
        `).join('');
      }
    }

    function setFilter(f) {
      currentFilter = f;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
      renderPecas();
    }

    // ============================================
    // MODAL PEDIR PE√áA
    // ============================================
    function openAddModal() {
      document.getElementById('addModal').classList.remove('hidden');
      document.getElementById('codigoInput').value = '';
      document.getElementById('nomeInput').value = '';
      document.getElementById('quantidadeInput').value = '';
      document.getElementById('obsInput').value = '';
      document.getElementById('infoEncontrada').style.display = 'none';
      document.getElementById('resultadoBusca').classList.add('hidden');
      currentInfoPeca = null;
    }

    function closeAddModal() { document.getElementById('addModal').classList.add('hidden'); }

    async function buscarPeca() {
      const codigo = document.getElementById('codigoInput').value.trim();
      if (!codigo) return;

      const btn = document.getElementById('buscarBtn');
      btn.disabled = true; btn.textContent = '‚è≥ Buscando...';
      
      const resultado = document.getElementById('resultadoBusca');
      resultado.classList.add('hidden');
      document.getElementById('infoEncontrada').style.display = 'none';

      try {
        const res = await fetch(`${SERVER_URL}/buscar/${encodeURIComponent(codigo)}`);
        const info = await res.json();

        if (info.encontrado) {
          currentInfoPeca = info;
          renderInfoEncontrada(info);
          if (info.nome) {
            document.getElementById('nomeInput').value = info.nome;
          }
        } else {
          resultado.className = 'resultado-busca nao-encontrado';
          resultado.innerHTML = `‚ö†Ô∏è ${info.mensagem}`;
          resultado.classList.remove('hidden');
        }
      } catch(e) {
        resultado.className = 'resultado-busca nao-encontrado';
        resultado.innerHTML = '‚ùå Erro na busca. Preencha manualmente.';
        resultado.classList.remove('hidden');
      }

      btn.disabled = false; btn.textContent = 'üîç Buscar no Cat√°logo';
    }

    function renderInfoEncontrada(info) {
      const div = document.getElementById('infoEncontrada');
      div.innerHTML = `
        <div class="info-header">‚úÖ Encontrado no cat√°logo!</div>
        ${info.tipo ? `<div class="info-row"><span class="info-label">Tipo:</span><span class="info-value">${info.tipo}</span></div>` : ''}
        ${info.marca ? `<div class="info-row"><span class="info-label">Marca:</span><span class="info-value">${info.marca}</span></div>` : ''}
        ${info.aplicacao && info.aplicacao.length > 0 ? `<div><span class="info-label">üöó Ve√≠culos:</span><div class="veiculos-lista">${info.aplicacao.map(v => `<span class="veiculo-tag">${v}</span>`).join('')}</div></div>` : ''}
      `;
      div.style.display = 'block';
    }

    function submitPeca() {
      const codigo = document.getElementById('codigoInput').value.trim();
      if (!codigo) { alert('Informe o c√≥digo!'); return; }
      sendMessage('addPeca', { peca: {
        codigo: codigo.toUpperCase(),
        nome: document.getElementById('nomeInput').value.trim() || 'Pe√ßa',
        quantidade: document.getElementById('quantidadeInput').value.trim(),
        observacao: document.getElementById('obsInput').value.trim(),
        infoPeca: currentInfoPeca,
        status: 'pendente',
        pedidoPor: currentUser.name
      }});
      closeAddModal();
    }

    // ============================================
    // MODAL CAT√ÅLOGO (S√ì ADMIN)
    // ============================================
    function openCatalogoModal() {
      document.getElementById('catalogoModal').classList.remove('hidden');
      document.getElementById('catCodigoInput').value = '';
      document.getElementById('catTipoInput').value = '';
      document.getElementById('catMarcaInput').value = '';
      document.getElementById('catVeiculosInput').value = '';
      document.getElementById('catalogoResultado').classList.add('hidden');
      selectedTipo = '';
      document.querySelectorAll('.tipo-option').forEach(el => el.classList.remove('selected'));
      loadCatalogoStats();
    }

    function closeCatalogoModal() { document.getElementById('catalogoModal').classList.add('hidden'); }

    function selectTipo(el, tipo) {
      document.querySelectorAll('.tipo-option').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      selectedTipo = tipo;
      document.getElementById('catTipoInput').value = '';
    }

    async function cadastrarPeca() {
      const codigo = document.getElementById('catCodigoInput').value.trim();
      const tipoInput = document.getElementById('catTipoInput').value.trim();
      const tipo = tipoInput || selectedTipo;
      const marca = document.getElementById('catMarcaInput').value.trim();
      const veiculosText = document.getElementById('catVeiculosInput').value.trim();
      
      const resultado = document.getElementById('catalogoResultado');
      
      if (!codigo || !tipo || !marca) {
        resultado.className = 'resultado-busca nao-encontrado';
        resultado.innerHTML = '‚ö†Ô∏è Preencha c√≥digo, tipo e marca!';
        resultado.classList.remove('hidden');
        return;
      }
      
      const veiculos = veiculosText ? veiculosText.split(',').map(v => v.trim()).filter(v => v) : [];
      
      try {
        const res = await fetch(`${SERVER_URL}/catalogo`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ codigo, tipo, marca, veiculos })
        });
        
        const data = await res.json();
        
        if (data.sucesso) {
          resultado.className = 'resultado-busca encontrado';
          resultado.innerHTML = `‚úÖ ${data.mensagem}<br>Total no cat√°logo: ${data.totalCatalogo} pe√ßas`;
          resultado.classList.remove('hidden');
          document.getElementById('catalogoTotal').textContent = data.totalCatalogo;
          
          // Limpa campos
          document.getElementById('catCodigoInput').value = '';
          document.getElementById('catTipoInput').value = '';
          document.getElementById('catMarcaInput').value = '';
          document.getElementById('catVeiculosInput').value = '';
          selectedTipo = '';
          document.querySelectorAll('.tipo-option').forEach(el => el.classList.remove('selected'));
        } else {
          resultado.className = 'resultado-busca nao-encontrado';
          resultado.innerHTML = `‚ö†Ô∏è ${data.erro}`;
          resultado.classList.remove('hidden');
        }
      } catch(e) {
        resultado.className = 'resultado-busca nao-encontrado';
        resultado.innerHTML = '‚ùå Erro ao cadastrar. Tente novamente.';
        resultado.classList.remove('hidden');
      }
    }

    // ============================================
    // MODAL DETALHES
    // ============================================
    function openDetailModal(id) {
      const peca = pecas.find(p => p.id === id);
      if (!peca) return;
      currentDetailPeca = peca;
      const isAdmin = currentUser.role === 'admin';
      
      let html = `
        <div class="detail-row"><span class="detail-label">C√≥digo:</span><span class="detail-value">${peca.codigo}</span></div>
        <div class="detail-row"><span class="detail-label">Nome:</span><span class="detail-value">${peca.nome || '-'}</span></div>
        ${peca.quantidade ? `<div class="detail-row"><span class="detail-label">Qtd:</span><span class="detail-value">${peca.quantidade}</span></div>` : ''}
        <div class="detail-row"><span class="detail-label">Status:</span><span class="peca-status status-${peca.status}">${STATUS_CONFIG[peca.status]?.icon} ${STATUS_CONFIG[peca.status]?.label}</span></div>
        ${peca.dataEstimada ? `<div class="detail-row"><span class="detail-label">üìÖ Previs√£o:</span><span class="detail-value">${peca.dataEstimada}</span></div>` : ''}
        ${peca.motivo ? `<div class="detail-row"><span class="detail-label">‚ùå Motivo:</span><span class="detail-value">${peca.motivo}</span></div>` : ''}
        <div class="detail-row"><span class="detail-label">Pedido por:</span><span class="detail-value">${peca.pedidoPor}</span></div>
        <div class="detail-row"><span class="detail-label">Data:</span><span class="detail-value">${new Date(peca.data).toLocaleString('pt-BR')}</span></div>
      `;

      if (peca.infoPeca?.aplicacao?.length > 0) {
        html += `<div class="info-encontrada" style="display:block;margin-top:15px"><div class="info-header">üöó Ve√≠culos:</div><div class="veiculos-lista">${peca.infoPeca.aplicacao.map(v => `<span class="veiculo-tag">${v}</span>`).join('')}</div></div>`;
      }

      if (isAdmin) {
        html += `<div class="admin-actions"><p class="admin-title">‚ö° A√ß√µes:</p><div class="status-buttons">
          ${peca.status !== 'pendente' ? `<button class="status-btn status-pendente" onclick="updateStatus('pendente')">üü° Pendente</button>` : ''}
          ${peca.status !== 'comprado' ? `<button class="status-btn status-comprado" onclick="openCompradoModal()">üü¢ Pedido Feito</button>` : ''}
          ${peca.status !== 'nao_possivel' ? `<button class="status-btn status-nao_possivel" onclick="openNaoDisponivelModal()">üî¥ N√£o Dispon√≠vel</button>` : ''}
          ${peca.status !== 'chegou' ? `<button class="status-btn status-chegou" onclick="updateStatus('chegou')">‚úÖ Chegou</button>` : ''}
        </div><button class="delete-btn" onclick="deletePeca()">üóëÔ∏è Excluir</button></div>`;
      } else {
        html += `<div class="func-info">‚ÑπÔ∏è Apenas administradores podem alterar o status.</div>`;
      }

      document.getElementById('detailBody').innerHTML = html;
      document.getElementById('detailModal').classList.remove('hidden');
    }

    function closeDetailModal() { document.getElementById('detailModal').classList.add('hidden'); currentDetailPeca = null; }
    function updateStatus(status, extras = {}) { if (currentDetailPeca) { sendMessage('updateStatus', { pecaId: currentDetailPeca.id, status, ...extras }); closeDetailModal(); } }
    function deletePeca() { if (currentDetailPeca && confirm('Excluir?')) { sendMessage('deletePeca', { pecaId: currentDetailPeca.id }); closeDetailModal(); } }

    function openCompradoModal() { document.getElementById('compradoModal').classList.remove('hidden'); document.getElementById('dataEstimadaInput').value = ''; }
    function closeCompradoModal() { document.getElementById('compradoModal').classList.add('hidden'); }
    function confirmComprado() { updateStatus('comprado', { dataEstimada: document.getElementById('dataEstimadaInput').value.trim() }); closeCompradoModal(); }

    function openNaoDisponivelModal() { document.getElementById('naoDisponivelModal').classList.remove('hidden'); document.getElementById('motivoSelect').value = ''; }
    function closeNaoDisponivelModal() { document.getElementById('naoDisponivelModal').classList.add('hidden'); }
    function confirmNaoDisponivel() { updateStatus('nao_possivel', { motivo: document.getElementById('motivoSelect').value }); closeNaoDisponivelModal(); }
  </script>
</body>
</html>
